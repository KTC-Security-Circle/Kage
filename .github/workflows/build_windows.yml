name: build-windows

# 手動実行のみに変更
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "リリースタグ名 (例: v1.0.0)"
        required: true
        default: "v0.0.1"
      version:
        description: "バージョン番号（例: 1.0.0）"
        required: false
        default: "0.0.1"
      build_number:
        description: "ビルド番号"
        required: false
        default: "1"

# 環境変数
env:
  BUILD_NUMBER: ${{ github.event.inputs.build_number }}
  BUILD_VERSION: ${{ github.event.inputs.version }}
  RELEASE_TAG: ${{ github.event.inputs.tag }}
  PYTHON_VERSION: 3.12.5
  FLUTTER_VERSION: 3.27.4
  PYTHONUTF8: 1

# Releaseの作成
jobs:
  ruff-check:
    uses: ./.github/workflows/ruff_check.yml

  create-release:
    needs: ruff-check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: "Create Release"
        run: gh release create ${{ env.RELEASE_TAG }} --draft --notes "Release ${{ env.RELEASE_TAG }} created"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows-build:
    needs: create-release
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Codes
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set environment variable for UTF-8
        run: echo "PYTHONUTF8=1" >> $env:GITHUB_ENV

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip  
          pip install .

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: Windows Build
        run: |
          chcp 65001
          flutter config --no-analytics
          flet build windows --verbose --no-rich-output --build-number=${{ env.BUILD_NUMBER }} --build-version=${{ env.BUILD_VERSION }}
          Compress-Archive -Path ./build/windows/* -DestinationPath ./build/windows/${{ vars.APP_NAME }}_windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-artifact
          path: build/windows
          if-no-files-found: error
          overwrite: false

      - name: Upload Release
        run: gh release upload ${{ env.RELEASE_TAG }} ./build/windows/${{ vars.APP_NAME }}_windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
